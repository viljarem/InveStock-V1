name: ğŸ“ˆ Automatisk Markedsdata Oppdatering

on:
  schedule:
    # KjÃ¸rer hver dag kl 17:00 CET (16:00 UTC vintertid, 15:00 UTC sommertid)
    - cron: '0 16 * * 1-5'  # Mandag til fredag kl 16:00 UTC (17:00 CET vintertid)
    - cron: '0 15 * * 1-5'  # Mandag til fredag kl 15:00 UTC (17:00 CEST sommertid)
  
  # Tillat manuell kjÃ¸ring
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Tving oppdatering av alle data (ignorer cache)'
        required: false
        default: 'false'
        type: boolean

env:
  # Sett miljÃ¸variabler for PyTorch kompatibilitet
  PYTORCH_ENABLE_MPS_FALLBACK: '1'
  CUDA_VISIBLE_DEVICES: ''
  PYTORCH_MPS_DISABLE: '1'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Hent kode
      uses: actions/checkout@v4
      with:
        # VIKTIG: Bruk Personal Access Token for Streamlit Cloud
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ Sett opp Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installer avhengigheter
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ• Vis norsk tid
      run: |
        echo "UTC tid: $(date -u)"
        echo "Norsk tid: $(TZ='Europe/Oslo' date)"
    
    - name: ğŸ“ˆ Oppdater markedsdata
      run: |
        echo "ğŸ¤– Starter automatisk dataoppdatering..."
        python update_market_data.py
    
    - name: ğŸ“‹ Sjekk endringer
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Endringer funnet:"
          git status --porcelain
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "âœ… Ingen nye endringer"
        fi
    
    - name: ğŸ’¾ Commit og push for Streamlit Cloud
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # Konfigurer Git med Personal Access Token
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action - Streamlit Data Update"
        
        # Debug: Sjekk token og remote
        echo "Git remote URL: $(git remote get-url origin)"
        
        # Legg til kun datafiler (unngÃ¥ __pycache__)
        git add data_storage/*.parquet data_storage/*.json
        
        # Sjekk om det er noe Ã¥ committe
        if git diff --staged --quiet; then
          echo "âš ï¸  Ingen datafiler endret"
          exit 0
        fi
        
        # Commit med norsk tidsstempel
        NORSK_TID=$(TZ='Europe/Oslo' date '+%Y-%m-%d %H:%M:%S')
        git commit -m "ğŸ¤– Streamlit Cloud: Automatisk dataoppdatering - $NORSK_TID"
        
        # Push til main branch for Streamlit Cloud
        echo "ğŸš€ Pusher oppdaterte datafiler til Streamlit Cloud..."
        git push origin main
        
        echo "âœ… Streamlit Cloud vil nÃ¥ ha fersk data!"
    
    - name: ğŸ‰ Oppsummering
      if: always()
      run: |
        echo "================================================="
        echo "ğŸ“‹ OPPSUMMERING AV GITHUB ACTIONS KJÃ˜RING"
        echo "================================================="
        echo "Tidspunkt: $(TZ='Europe/Oslo' date)"
        echo "Status: ${{ job.status }}"
        echo "Endringer: ${{ steps.check_changes.outputs.changes || 'ukjent' }}"
        echo "================================================="
        
        # Vis siste commit hvis det ble gjort endringer
        if [ "${{ steps.check_changes.outputs.changes }}" = "true" ]; then
          echo "ğŸ“ Siste commit:"
          git log -1 --oneline
        fi